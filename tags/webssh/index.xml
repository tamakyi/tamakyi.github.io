<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Webssh on 狼的公告板 ver.Hugo</title><link>https://blog.tama.guru/tags/webssh.html</link><description>Recent content in Webssh on 狼的公告板 ver.Hugo</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>tamakyi</copyright><lastBuildDate>Thu, 05 Feb 2026 01:17:00 +0000</lastBuildDate><atom:link href="https://blog.tama.guru/tags/webssh/index.xml" rel="self" type="application/rss+xml"/><item><title>通过Cloudflare零信任(cloudflare zero trush)给内网服务器做穿透并搭建webssh的小记</title><link>https://blog.tama.guru/record/cloudflare_webssh_zerotrush.html</link><pubDate>Fri, 18 Aug 2023 14:23:00 +0800</pubDate><guid>https://blog.tama.guru/record/cloudflare_webssh_zerotrush.html</guid><description>&lt;p>通过cloudflare zero trush可以非常快速且方便的搭建内网穿透，而且速度一般情况下可以接受，最重要的是成本很低，你只需要：&lt;/p>
&lt;ol>
&lt;li>一个cloudflare账号&lt;/li>
&lt;li>一个托管到cloudflare的域名&lt;/li>
&lt;/ol>
&lt;p>以上内容百度到处都是，不再赘述，以下仅记录搭建webssh的过程。&lt;/p>
&lt;hr>
&lt;p>####1、安装并配置tunnel
需要在ssh服务器上执行如下命令：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#安装cloudflared，我用的arch，其他平台自己替换。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman -S cloudflared
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#这一步执行后会得到一个链接，复制到浏览器打开，然后选择一个托管到cloudflare的域名，确认之后会将对应的pem证书推到你服务器的.cloudflare目录下。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cloudflared tunnel login
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#创建一个tunnel，其中$tunnel-name自行配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cloudflared tunnel create $tunnel-name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#查看tunnel列表
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cloudflared tunnel list
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>此时在输出的列表中找到刚才创建的tunnel名为$tunnel-name对应的ID，一般格式为&lt;code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&lt;/code>。
####2.创建配置文件。
进入用户目录下的&lt;code>.cloudflared&lt;/code>文件夹，创建名为&lt;code>config.yam&lt;/code>的文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">tunnel: &lt;span class="nv">$ID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">credentials-file: /home/&lt;span class="nv">$username&lt;/span>/.cloudflared/&lt;span class="nv">$ID&lt;/span>.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ssh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - hostname: ssh.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service: ssh://localhost
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># vnc远程桌面，端口5900&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - hostname: vnc.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service: tcp://localhost:5900
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 其他http服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - hostname: file.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service: http://localhost:9527
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - hostname: speed-test.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service: http://localhost:9898
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 如果都没有匹配，则返回404，这句不能少&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - service: http_status:404
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中$ID替换为上面的ID，$username为你服务器本地用户名，&lt;code>hostname&lt;/code>字段对应外网访问的网址，&lt;code>service&lt;/code>字段对应内网网址，如果是带端口的在后面增加即可。
####3.写一个脚本，自动更新DNS以及运行tunnel
&lt;code>vim ~/tunnel-sh.sh&lt;/code>
内容如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># update cloudflare DNS record
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/cloudflared tunnel route dns $tunnel-name ssh.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/cloudflared tunnel route dns $tunnel-name vnc.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/cloudflared tunnel route dns $tunnel-name file.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/cloudflared tunnel route dns $tunnel-name speed-test.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># run tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/cloudflared tunnel run $tunnel-name
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意把$tunnel-name和网址换成自己的。
####4.开机自启
新建一个service，
&lt;code>sudo vim /etc/systemd/system/cloudflared-tunnel.service&lt;/code>
内容如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Unit&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Description&lt;/span>&lt;span class="o">=&lt;/span>cloudflared tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Wants&lt;/span>&lt;span class="o">=&lt;/span>network-online.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">After&lt;/span>&lt;span class="o">=&lt;/span>network-online.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Service&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">User&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$username&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>sh /home/&lt;span class="nv">$username&lt;/span>/tunnel-sh.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Install&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>default.target
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意把$username换成自己的。
####5.启动&amp;amp;开机自启&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sudo systemctl start cloudflared-tunnel.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl enable cloudflared-tunnel.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>####6.配置application
ssh是无法直接访问的，但是cloudflare提供了application套件，配置位于cloudflare的zerotrush下的access目录。
进去之后选择&lt;code>add an application&lt;/code>，类型选&lt;code>self hosted&lt;/code>
&lt;code>Application Configuration&lt;/code>配置如下：
&lt;code>Application name(Required)&lt;/code>:app名称，随意设定
&lt;code>Session Duration(Required)&lt;/code>:会话时长，设置一次会话多久超时，一般默认24即可。
&lt;code>Application domain&lt;/code>:我们在服务器上的配置中ssh访问链接为ssh.example.com，因此这里填&lt;code>ssh&lt;/code>
&lt;code>Domain(Required)&lt;/code>:域名，我们在服务器上的配置中ssh访问链接为ssh.example.com，因此这里填&lt;code>example.com&lt;/code>
然后点击next。
&lt;code>Policy&lt;/code>配置与安全性相关：，规则名称
&lt;code>Policy name&lt;/code>：随意设定
&lt;code>Action&lt;/code>:选择这个规则下的内容允许还是拒绝
&lt;code>Session duration&lt;/code>：一次会话多久过期
&lt;code>Configure rules&lt;/code>配置如下：
&lt;code>Selector&lt;/code>:规则认证方式，以email为例，会要求每次进入网页验证邮箱PIN码
&lt;code>Value&lt;/code>：规则，与&lt;code>Selector&lt;/code>相关。
然后点击next。
在&lt;code>Additional settings&lt;/code>下的&lt;code>Browser rendering&lt;/code>切换为SSH，最后点击&lt;code>add application&lt;/code>即可web访问到ssh了。&lt;/p></description></item></channel></rss>